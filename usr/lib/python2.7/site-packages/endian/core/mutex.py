#!/usr/bin/env python
# encoding: utf-8
#
# +--------------------------------------------------------------------------+
# | Endian Firewall                                                          |
# +--------------------------------------------------------------------------+
# | Copyright (c) 2005-2011 Endian                                           |
# |         Endian GmbH/Srl                                                  |
# |         Bergweg 41 Via Monte                                             |
# |         39057 Eppan/Appiano                                              |
# |         ITALIEN/ITALIA                                                   |
# |         info@endian.com                                                  |
# |                                                                          |
# | endian-core is free software: you can redistribute it and/or modify      |
# | it under the terms of GNU General Public License (GPL) version 2.0       |
# | when released with the Community edition                                 |
# | or the GNU Lesser General Public License (LGPL) version 2.1              |
# | when released with the Enterprise edition.                               |
# |                                                                          |
# | endian-core is distributed in the hope that it will be useful,           |
# | but WITHOUT ANY WARRANTY; without even the implied warranty of           |
# | MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the             |
# | GNU General Public License for more details or the                       |
# | GNU Lesser General Public License for more details.                      |
# |                                                                          |
# | You should have received a copy of the license along with endian-core.   |
# | If not, see <http://www.gnu.org/licenses/>.                              |
# +--------------------------------------------------------------------------+
#

"""
--- mutex class ---
@author Peter Warasin <peter@endian.com>
@copyright (c) Endian 2008

implements file mutex

"""

from os import getpid
from fcntl import flock, LOCK_UN, LOCK_EX, LOCK_NB

class FileMutex:
    def __init__(self, mutexfile):
        """
        Creates a FileMutex with mutexfile 'mutexfile'.
        """
        self.mutexfile = mutexfile
        self.mypid = getpid()

    def acquire(self, blocking=True):
        """
        Blocks immediately if the lockfile already exists and the
        creating process is still running.
        """
        blocking_value = 0
        if not blocking:
            blocking_value = LOCK_NB
        self._fd = open(self.mutexfile, "w+")
        flock(self._fd, LOCK_EX | blocking_value)
        self._fd.write("%d\n" % self.mypid)
        self._fd.flush()

    def release(self):
        """
        Releases the lock
        """
        flock(self._fd, LOCK_UN)
        self._fd.close()

if __name__ == '__main__':
    a = FileMutex("testfile")
    print "Acquire"
    a.acquire(False)
    print "Got"
    import time
    time.sleep(10)
    print "Release"
    a.release()

