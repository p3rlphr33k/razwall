#!/usr/bin/env python  
# encoding: utf-8
#
# +--------------------------------------------------------------------------+
# | Endian Firewall                                                          |
# +--------------------------------------------------------------------------+
# | Copyright (c) 2005-2011 Endian                                           |
# |         Endian GmbH/Srl                                                  |
# |         Bergweg 41 Via Monte                                             |
# |         39057 Eppan/Appiano                                              |
# |         ITALIEN/ITALIA                                                   |
# |         info@endian.com                                                  |
# |                                                                          |
# | endian-core is free software: you can redistribute it and/or modify      |
# | it under the terms of GNU General Public License (GPL) version 2.0       |
# | when released with the Community edition                                 |
# | or the GNU Lesser General Public License (LGPL) version 2.1              |
# | when released with the Enterprise edition.                               |
# |                                                                          |
# | endian-core is distributed in the hope that it will be useful,           |
# | but WITHOUT ANY WARRANTY; without even the implied warranty of           |
# | MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the             |
# | GNU General Public License for more details or the                       |
# | GNU Lesser General Public License for more details.                      |
# |                                                                          |
# | You should have received a copy of the license along with endian-core.   |
# | If not, see <http://www.gnu.org/licenses/>.                              |
# +--------------------------------------------------------------------------+
#

import termios
import sys

__author__ = "Andrea Bonomi <a.bonomi@endian.com>"
__date__ = "2010-10-26"


RESET =     '\033[0m'  # reset
BOLD =      '\033[1m'  # hicolor
UNDERLINE = '\033[4m'  # underline
BLINK =     '\033[5m'  # blink
INVERSE =   '\033[7m'  # inverse
CLEAR =     '\033[H\033[J' # clear screen
CLEAR_LINE ='\033[2K'  # clear line

BLACK =     '\033[30m' # foreground black
RED =       '\033[31m' # foreground red
GREEN =     '\033[32m' # foreground green
YELLOW =    '\033[33m' # foreground yellow
BLUE =      '\033[34m' # foreground blue
MAGENTA =   '\033[35m' # foreground magenta
CYAN =      '\033[36m' # foreground cyan
WHITE =     '\033[37m' # foreground white

BBLACK =    '\033[40m' # background black
BRED =      '\033[41m' # background red
BGREEN =    '\033[42m' # background green
BYELLOW =   '\033[43m' # background yellow
BBLUE =     '\033[44m' # background blue
BMAGENTA =  '\033[45m' # background magenta
BCYAN =     '\033[46m' # background cyan
BWHITE =    '\033[47m' # background white

SAVE_POSITION =    '\0337'     # save cursor position
RESTORE_POSITION = '\0338'     # restore cursor position
CURSOR_TOP =       '\033[1;1H'  # move cursor to top left

def sane_tty(fd=None):
    """
    ... autofunction::: sane_tty
    Change the terminal line settings to a sane state, like the 'stty sane' command
    """    
    def get_termios_attributes(attrs):
        result = 0
        for attr in attrs:
            result |= getattr(termios, attr, 0)
        return result

    if fd == None:
        fd = sys.stdin
        
    mode = termios.tcgetattr(fd) # [iflag, oflag, cflag, lflag, ispeed, ospeed, cc]
    # iflag
    mode[0] &= ~get_termios_attributes(['INPCK','PARMRK','IGNBRK','ISTRIP','INLCR','IGNCR','IXOFF','IXANY','IUCLC'])
    mode[0] |= get_termios_attributes(['ICRNL','BRKINT','IGNPAR','IXON'])
    # oflag
    mode[1] &= ~get_termios_attributes(['OLCUC','OCRNL','ONLRET','ONOCR','OFILL','OFDEL'])
    mode[1] |= get_termios_attributes(['OPOST','ONLCR','NL0','CR0','TAB0','BS0','VT0','FF0'])
    # cflag
    mode[2] &= ~get_termios_attributes(['CSIZE','PARENB','CRTSCTS','CLOCAL','CSTOPB','HUPCL'])
    mode[2] |= get_termios_attributes(['CS8'])
    # lflag
    mode[3] &= ~get_termios_attributes(['ECHONL','ECHOPRT','NOFLSH','XCASE','TOSTOP'])
    mode[3] |= get_termios_attributes(['ICANON','ISIG','IEXTEN','ECHO','ECHOCTL','ECHOE','ECHOK','ECHOKE'])
    # cc
    mode[6][termios.VMIN] = 1
    mode[6][termios.VTIME] = 0
    termios.tcsetattr(fd, termios.TCSANOW, mode)
