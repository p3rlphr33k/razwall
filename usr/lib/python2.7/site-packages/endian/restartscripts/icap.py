#!/usr/bin/python
#
# +--------------------------------------------------------------------------+
# | Endian Firewall                                                          |
# +--------------------------------------------------------------------------+
# | Copyright (c) 2005-2010 Endian                                           |
# |         Endian GmbH/Srl                                                  |
# |         Bergweg 41 Via Monte                                             |
# |         39057 Eppan/Appiano                                              |
# |         ITALIEN/ITALIA                                                   |
# |         info@endian.com                                                  |
# |                                                                          |
# | endian-core is free software: you can redistribute it and/or modify      |
# | it under the terms of the GNU Lesser General Public License as published |
# | by the Free Software Foundation, either version 2.1 of the License, or   |
# | (at your option) any later version.                                      |
# |                                                                          |
# | endian-core is distributed in the hope that it will be useful,           |
# | but WITHOUT ANY WARRANTY; without even the implied warranty of           |
# | MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the            |
# | GNU Lesser General Public License for more details.                      |
# |                                                                          |
# | You should have received a copy of the GNU Lesser General Public License |
# | along with endian-core.  If not, see <http://www.gnu.org/licenses/>.     |
# +--------------------------------------------------------------------------+
#

from endian.job.commons import *
from endian.job.generic.servicejob import ServiceJob

class Icap(ServiceJob):
    serviceName = 'c-icap'
    settingsName = 'icap'
    serviceBlocking = True # wait for icap service to finish (UTM-213)
    serviceCanReload = True
    enabledkeys = ['ENABLED']
    configFiles = [
        {'file': "/etc/c-icap/c-icap.conf", 'affects': serviceName},
        {'file': "/etc/logrotate.d/c-icap", 'affects': 'nothing'},
        ]

    def load_config_hook(self):
        # XXX: go off to virtual datasource!
        self.debug("load_config hook")
        proxy = self.config_values['DS'].proxy.settings
        host = self.config_values['DS'].host.settings
        self.config_values['VISIBLE_HOSTNAME'] = proxy['VISIBLE_HOSTNAME']
        if self.config_values['VISIBLE_HOSTNAME'] == "":
            self.config_values['VISIBLE_HOSTNAME'] = "%(HOSTNAME)s.%(DOMAINNAME)s" % host

