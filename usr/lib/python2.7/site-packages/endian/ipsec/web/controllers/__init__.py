#!/usr/bin/env python
# encoding: utf-8
#
# +--------------------------------------------------------------------------+
# | Endian Firewall                                                          |
# +--------------------------------------------------------------------------+
# | Copyright (c) 2012-2013 Endian                                           |
# |         Endian GmbH/Srl                                                  |
# |         Bergweg 41 Via Monte                                             |
# |         39057 Eppan/Appiano                                              |
# |         ITALIEN/ITALIA                                                   |
# |         info@endian.com                                                  |
# |                                                                          |
# | efw-ipsec is free software: you can redistribute it and/or modify it     |
# | under the terms of GNU General Public License (GPL) version 2.0          |
# | when released with the Community edition                                 |
# | or the GNU Lesser General Public License (LGPL) version 2.1              |
# | when released with the Enterprise edition.                               |
# |                                                                          |
# | efw-ipsec is distributed in the hope that it will be useful,             |
# | but WITHOUT ANY WARRANTY; without even the implied warranty of           |
# | MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the             |
# | GNU General Public License for more details or the                       |
# | GNU Lesser General Public License for more details.                      |
# |                                                                          |
# | You should have received a copy of the license along with efw-ipsec.     |
# | If not, see <http://www.gnu.org/licenses/>.                              |
# +--------------------------------------------------------------------------+

import subprocess
import endian.core.i18n
from endian.emi import controllers
from endian.job.engine_control import send_cmd_to_engine
from endian.ipsec.schema import IPsecSettings
from endian.ipsec.web.controllers.settings import IPsecSettingsController
from endian.ipsec.web.controllers.connection import IPsecConnectionController
from endian.ipsec.web.widgets.connection import ConnectionInfoWidget

__all__ = [
    'IPsecController'
]

class IPsecController(controllers.SwitchController):
    switch_title = _("Enable IPsec")
    description = _("To enable IPsec click on the switch above.")
    switch_divider = True

    entity = IPsecSettings
    key = "ENABLED"
    connection_info_widget = ConnectionInfoWidget()

    def action(self):
        send_cmd_to_engine("restart sync ipsec")

    @controllers.expose(template="endian.emi.templates.basecontroller")
    def info(self, **args):
        """ Return the connection detailed info """
        name = args.get('name', None)
        if name is not None:
            text = subprocess.Popen(["/usr/sbin/ipsec", "statusall", name], stdout=subprocess.PIPE, stderr=subprocess.STDOUT).communicate()[0]
        else:
            text = subprocess.Popen(["/usr/sbin/ipsec", "statusall"], stdout=subprocess.PIPE, stderr=subprocess.STDOUT).communicate()[0]
        result = { 'args': { 'data': { 'text': text } },
                   'container': self.connection_info_widget,
                   'controllername': 'grid'}
        return result

    settings = IPsecSettingsController(name="settings")
    connection = IPsecConnectionController(name="connection")
    controllers = [settings, connection]


