#!/usr/bin/env python
# encoding: utf-8
#
# +--------------------------------------------------------------------------+
# | Endian Firewall                                                          |
# +--------------------------------------------------------------------------+
# | Copyright (c) 2012-2013 Endian                                           |
# |         Endian GmbH/Srl                                                  |
# |         Bergweg 41 Via Monte                                             |
# |         39057 Eppan/Appiano                                              |
# |         ITALIEN/ITALIA                                                   |
# |         info@endian.com                                                  |
# |                                                                          |
# | efw-ipsec is free software: you can redistribute it and/or modify it     |
# | under the terms of GNU General Public License (GPL) version 2.0          |
# | when released with the Community edition                                 |
# | or the GNU Lesser General Public License (LGPL) version 2.1              |
# | when released with the Enterprise edition.                               |
# |                                                                          |
# | efw-ipsec is distributed in the hope that it will be useful,             |
# | but WITHOUT ANY WARRANTY; without even the implied warranty of           |
# | MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the             |
# | GNU General Public License for more details or the                       |
# | GNU Lesser General Public License for more details.                      |
# |                                                                          |
# | You should have received a copy of the license along with efw-ipsec.     |
# | If not, see <http://www.gnu.org/licenses/>.                              |
# +--------------------------------------------------------------------------+

import time
from endian.core import commands
from endian.job.engine_control import send_cmd_to_engine
from endian.ipsec.schema import IPsecConnection

__all__= ['ipsec_reload',
          'reset_connection',
         ]

@commands.force_json_output
def ipsec_reload():
    """
    .. autofunction:: reload
        Write the IPSec configuration and reload the whole configuration on the running daemons
    """
    send_cmd_to_engine("call ipsec.reload")
    return { "info": 'Configuration reloaded' }

@commands.force_json_output
def reset_connection(name):
    """
    .. autofunction:: reset_connection
        Write the IPSec configuration, reload the whole configuration on the running daemons and
        reset (close and reopen) a VPN connection
        :param name: connection name
        :type name: str
    """
    send_cmd_to_engine("call ipsec.reload")
    send_cmd_to_engine("call ipsec.reset_connection", options={'name': name})
    time.sleep(3)
    IPsecConnection.invalidate_open_connections_cache()
    return { "info": 'VPN Connection resetted' }

commands.register('commands.ipsec.reload', ipsec_reload)
commands.register('commands.ipsec.resetConnection', reset_connection)

