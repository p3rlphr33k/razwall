#
# +--------------------------------------------------------------------------+
# | Endian Firewall                                                          |
# +--------------------------------------------------------------------------+
# | Copyright (c) 2005-2013 Endian                                           |
# |         Endian GmbH/Srl                                                  |
# |         Bergweg 41 Via Monte                                             |
# |         39057 Eppan/Appiano                                              |
# |         ITALIEN/ITALIA                                                   |
# |         info@endian.com                                                  |
# |                                                                          |
# | emi is free software: you can redistribute it and/or modify it under     |
# | the terms of GNU General Public License (GPL) version 2.0                |
# | when released with the Community edition                                 |
# | or the GNU Lesser General Public License (LGPL) version 2.1              |
# | when released with the Enterprise edition.                               |
# |                                                                          |
# | emi is distributed in the hope that it will be useful,                   |
# | but WITHOUT ANY WARRANTY; without even the implied warranty of           |
# | MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the             |
# | GNU General Public License for more details or the                       |
# | GNU Lesser General Public License for more details.                      |
# |                                                                          |
# | You should have received a copy of the license along with emi.           |
# | If not, see <http://www.gnu.org/licenses/>.                              |
# +--------------------------------------------------------------------------+
#

import time
import urllib
import urllib2
import simplejson
from endian.core import logger

__author__ = "Andrea Bonomi <a.bonomi@endian.com>"
__date__ = "2013-09-24"

EMI_PORT = 3131
EMI_HOST = "127.0.0.1"
CMD_PATH = "/manage/commands/"

__all__ = ['send_cmd_to_emi']

def send_cmd_to_emi(cmd, options=None, parse_json_result=True):
    """
    ... autofunction::: send_cmd_to_emi
        Send a cmd to EMI and wait for the response
        :param cmd: emi command
        :param options: commands options
        :param options: dict
        :param parse_json_result: if true, the commmand JSON output is parsed
        :param parse_json_result: boolean
    """
    if options:
        data = urllib.urlencode(options)
    else:
        data = ""
    try:
        url = "http://%s:%s%s%s" % (EMI_HOST, EMI_PORT, CMD_PATH, cmd)
        request = urllib2.Request(url, data)
        response = urllib2.urlopen(request)
        result = response.read()
        response.close()
        if parse_json_result:
            return simplejson.loads(result)
        else:
            return result
    except Exception, ex:
        logger.error("Error executing command %s" % cmd, exc_info=True)
        if parse_json_result:
            return { "error": "Error executing command %s" % cmd, "time": time.time()}
        else:
            return "Error executing command %s" % cmd

