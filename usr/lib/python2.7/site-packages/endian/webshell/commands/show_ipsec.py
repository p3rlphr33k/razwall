#
# +--------------------------------------------------------------------------+
# | Endian Firewall                                                          |
# +--------------------------------------------------------------------------+
# | Copyright (c) 2005-2012 Endian                                           |
# |         Endian GmbH/Srl                                                  |
# |         Bergweg 41 Via Monte                                             |
# |         39057 Eppan/Appiano                                              |
# |         ITALIEN/ITALIA                                                   |
# |         info@endian.com                                                  |
# |                                                                          |
# | efw-ipsec is free software: you can redistribute it and/or modify        |
# | it under the terms of the GNU Lesser General Public License as published |
# | by the Free Software Foundation, either version 2.1 of the License, or   |
# | (at your option) any later version.                                      |
# |                                                                          |
# | efw-ipsec is distributed in the hope that it will be useful,             |
# | but WITHOUT ANY WARRANTY; without even the implied warranty of           |
# | MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the            |
# | GNU Lesser General Public License for more details.                      |
# |                                                                          |
# | You should have received a copy of the GNU Lesser General Public License |
# | along with efw-ipsec.  If not, see <http://www.gnu.org/licenses/>.       |
# +--------------------------------------------------------------------------+
#

from endian.webshell.commons import context_aware, CommandException

@context_aware
def show_ipsec(cmd, *args, **argv):
    """
    ... autofunction::: show_ipsec

    Print IPsec connections information.\n
    Displays the IPsec connections information.

    Format:
    
    show ipsec [NAME]

    Options:

    NAME        Displays all connections that match NAME.

    """

    from endian.webshell.options import ShellOptionParser
    from endian.job.engine_control import send_cmd_to_engine

    context = argv['context']
    parser = ShellOptionParser(prog=cmd)
    (options, argc) = parser.parse_args(args)
    
    name = argc and argc[0]
    if name:
        name = name.lower()
    
    connections =  [y for y in [x[4:].split(" ", 2) for x in send_cmd_to_engine("call ipsec.connections").split('\n')] if len(y) == 3]

    context.write("${ANSI_GREEN}IPsec server connections of $HOSTNAME at $TIME on $DATE$ANSI_RESET")
    context.write("${ANSI_GREEN}Name             Status           Connected Since$ANSI_RESET")
    for (connection_name, status, since) in connections: 
        if not name or connection_name.lower().startswith(name):
            context.write("%-16s %-16s %s" % (connection_name, status, since))

